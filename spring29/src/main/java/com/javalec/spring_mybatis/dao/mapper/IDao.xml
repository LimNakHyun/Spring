<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.javalec.spring_mybatis.dao.IDao">
	
	<!-- 게시글 목록을 받아오는 쿼리 -->
	<select id="pagingListDao" parameterType="com.javalec.spring_mybatis.vo.CriteriaVO" resultType="com.javalec.spring_mybatis.dto.ContentDto">
		<![CDATA[
		select numbering, num, usrname, pwd, subject, cnt, date
			from (
				select (row_number() over()) as numbering, t.*
					from (
									select *
									from boardtest3
									where delyn = false and
		]]>
									<if test="searchType == 'subject'">subject ilike '%' || #{search} || '%'</if>
									<if test="searchType == 'content'">content ilike '%' || #{search} || '%'</if>
									<if test="searchType == 'usrname'">usrname ilike '%' || #{search} || '%'</if>
									<if test="searchType == 'subCon'">subject ilike '%' || #{search} || '%' or content ilike '%' || #{search} || '%'</if>
									<if test="searchType == null or searchType == '' ">1 = 1</if>
		<![CDATA[
									order by num desc
									) t
					) s
		where numbering > (#{nowPage} - 1) * #{cntPerPage} and numbering <= #{nowPage} * #{cntPerPage}
		]]>
	</select>
	
	<!-- 총 게시글 갯수를 출력하는 쿼리 -->
	<select id="countBoard" resultType="int">
		select count(*) 
		from boardtest3
		where delyn = 'false' and
		<if test="searchType == 'subject'">subject ilike '%' || #{search} || '%'</if>
		<if test="searchType == 'content'">content ilike '%' || #{search} || '%'</if>
		<if test="searchType == 'usrname'">usrname ilike '%' || #{search} || '%'</if>
		<if test="searchType == 'subCon'">(subject ilike '%' || #{search} || '%' or content ilike '%' || #{search} || '%')</if>
		<if test="searchType == null or searchType == '' ">1 = 1</if>
	</select>
	
	<!-- 게시글 작성 쿼리 -->
	<insert id="writeDao" parameterType="com.javalec.spring_mybatis.dto.ContentDto">
		insert into boardtest3 (num, usrname, pwd, subject, content, cnt, delyn, deldate, date)
		values (default, #{usrname}, #{pwd}, #{subject}, #{content}, '0', default, default, now())
	</insert>
	
	<!-- 게시글 삭제 쿼리 -->
	<delete id="deleteDao" parameterType="com.javalec.spring_mybatis.vo.CriteriaVO">
		update boardtest3 
		set delyn = 'true', deldate = now() 
		where num = #{num}
	</delete>

	<!-- 게시글 상세보기 쿼리 -->
	<select id="viewDao" parameterType="com.javalec.spring_mybatis.vo.CriteriaVO" resultType="com.javalec.spring_mybatis.dto.ContentDto">
		select *
			from (
				select (row_number() over()) as numbering, t.*
					from (
									select *
									from boardtest3
									where delyn = false and
									<if test="searchType == 'subject'">subject ilike '%' || #{search} || '%'</if>
									<if test="searchType == 'content'">content ilike '%' || #{search} || '%'</if>
									<if test="searchType == 'usrname'">usrname ilike '%' || #{search} || '%'</if>
									<if test="searchType == 'subCon'">subject ilike '%' || #{search} || '%' or content ilike '%' || #{search} || '%'</if>
									<if test="searchType == null or searchType == '' ">1 = 1</if>
									order by num desc
									) t
					) s
		where num = #{num}
	</select>
	
	<!-- 게시글 조회수 쿼리 -->
	<update id="cntDao" parameterType="com.javalec.spring_mybatis.vo.CriteriaVO">
		update boardtest3 
		set cnt = cnt + 1 
		where num = #{num}
	</update>
	
	<!-- 게시글 수정 쿼리 -->
	<update id="updateDao" parameterType="com.javalec.spring_mybatis.vo.CriteriaVO">
		update boardtest3 
		set subject = #{subject}, content = #{content} 
		where num = #{num}
	</update>

	<!-- 수정 및 삭제시 비밀번호 체크 쿼리 -->
	<select id="confirmPwd" parameterType="com.javalec.spring_mybatis.vo.CriteriaVO" resultType="int">
		SELECT CASE WHEN EXISTS (
		    SELECT *
		    FROM boardtest3
		    WHERE pwd = #{confirmPwd}
		    and num = #{num}
		)
		THEN CAST(1 AS BIT)
		ELSE CAST(0 AS BIT) end;
	</select>

</mapper>

