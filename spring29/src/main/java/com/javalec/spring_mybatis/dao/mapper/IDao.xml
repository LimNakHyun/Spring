<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.javalec.spring_mybatis.dao.IDao">
	
	
	<!-- 받아오는 값이 있었기 때문에 resultType이 존재함 -->
	<select id="pagingListDao" parameterType="com.javalec.spring_mybatis.vo.CriteriaVO" resultType="com.javalec.spring_mybatis.dto.ContentDto">
		<![CDATA[
		select numbering, num, usrname, pwd, subject, cnt, date
			from (
				select (row_number() over()) as numbering, t.*
					from (
									select *
									from boardtest3
									where delyn = false and
		]]>
									<if test="searchType == 'subject'">subject ilike '%' || #{search} || '%'</if>
									<if test="searchType == 'content'">content ilike '%' || #{search} || '%'</if>
									<if test="searchType == 'usrname'">usrname ilike '%' || #{search} || '%'</if>
									<if test="searchType == 'subCon'">subject ilike '%' || #{search} || '%' or content ilike '%' || #{search} || '%'</if>
									<if test="searchType == null or searchType == '' ">1 = 1</if>
		<![CDATA[
									order by num desc
									) t
					) s
		where numbering > (#{nowPage} - 1) * #{cntPerPage} and numbering <= #{nowPage} * #{cntPerPage}
		]]>
	</select>
	
	<!-- 총 게시글 갯수를 출력하는 쿼리 -->
	<select id="countBoard" resultType="int">
		select count(*) 
		from boardtest3
		where delyn = 'false' and
		<if test="searchType == 'subject'">subject ilike '%' || #{search} || '%'</if>
		<if test="searchType == 'content'">content ilike '%' || #{search} || '%'</if>
		<if test="searchType == 'usrname'">usrname ilike '%' || #{search} || '%'</if>
		<if test="searchType == 'subCon'">(subject ilike '%' || #{search} || '%' or content ilike '%' || #{search} || '%')</if>
		<if test="searchType == null or searchType == '' ">1 = 1</if>
	</select>
	
	<!-- 받아오는 값이 없었기 때문에 resultType이 존재하지 않음 -->
	<!-- #을 붙이면 들어오는 값을 반환 타입에 맞게 조정해 준다. -->
	<!-- $를 붙이면 String이 오면 그냥 데이터베이스에 밀어넣는다 -->
	<insert id="writeDao" parameterType="com.javalec.spring_mybatis.dto.ContentDto">
		insert into boardtest3 (num, usrname, pwd, subject, content, cnt, delyn, deldate, date)
		values (default, #{usrname}, #{pwd}, #{subject}, #{content}, '0', default, default, now())
	</insert>
	
	<!-- 메소드명은 인터페이스에 있는것을 그대로 가져와보자 -->
	<delete id="deleteDao" parameterType="int">
		<!-- delete from boardtest2 where num = ${param1} -->
		update boardtest3 set delyn = 'true', deldate = now() where num = ${param1}
	</delete>

	<select id="viewDao" parameterType="com.javalec.spring_mybatis.vo.CriteriaVO" resultType="com.javalec.spring_mybatis.dto.ContentDto">
		select *
			from (
				select (row_number() over()) as numbering, t.*
					from (
									select *
									from boardtest3
									where delyn = false and
									<if test="searchType == 'subject'">subject ilike '%' || #{search} || '%'</if>
									<if test="searchType == 'content'">content ilike '%' || #{search} || '%'</if>
									<if test="searchType == 'usrname'">usrname ilike '%' || #{search} || '%'</if>
									<if test="searchType == 'subCon'">subject ilike '%' || #{search} || '%' or content ilike '%' || #{search} || '%'</if>
									<if test="searchType == null or searchType == '' ">1 = 1</if>
									order by num desc
									) t
					) s
		where num = #{num}
	</select>
	
	<update id="cntDao" parameterType="com.javalec.spring_mybatis.vo.CriteriaVO">
		update boardtest3 set cnt = cnt + 1 where num = #{num}
	</update>
	
	<update id="updateDao" parameterType="int">
		update boardtest3 set subject = #{param1}, content = #{param2} where num = ${param3}
	</update>

	<select id="confirmPwd" resultType="ContentDto">
		select * from boardtest3 where num = #{param1} and pwd = #{param2}
	</select>

</mapper>

